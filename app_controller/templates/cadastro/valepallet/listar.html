<!-- Modal para exibir o QR Code -->
<div class="modal fade" id="qrCodeModal" tabindex="-1" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Vale Pallet Registrado</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body text-center">
                <div id="qrCodeContainer"></div>
                <p class="mt-3">Vale registrado com sucesso!</p>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-primary" data-bs-dismiss="modal">Fechar</button>
                <a href="{% url 'movimentacao_listar' %}" class="btn btn-success">Ver Movimentações</a>
            </div>
        </div>
    </div>
</div>
</div>
</main>

<script>
    document.addEventListener('DOMContentLoaded', function () {
        // Definir data atual como padrão
        const today = new Date().toISOString().split('T')[0];
        document.getElementById('data_validade').value = today;

        // Envio do formulário via AJAX para exibir o QR Code
        document.getElementById('valeForm').addEventListener('submit', function (e) {
            e.preventDefault();

            const formData = new FormData(this);

            fetch(this.action, {
                method: 'POST',
                body: formData,
                headers: {
                    'X-CSRFToken': document.querySelector('[name=csrfmiddlewaretoken]').value
                }
            })
                .then(response => response.json())
                .then(data => {
                    if (data.qr_code_url) {
                        // Exibe o QR Code no modal
                        const qrContainer = document.getElementById('qrCodeContainer');
                        qrContainer.innerHTML = `<img src="${data.qr_code_url}" alt="QR Code" class="img-fluid">`;

                        // Mostra o modal
                        const modal = new bootstrap.Modal(document.getElementById('qrCodeModal'));
                        modal.show();

                        // Redireciona para movimentações após fechar o modal (opcional)
                        document.querySelector('#qrCodeModal .btn-primary').addEventListener('click', function () {
                            window.location.href = "{% url 'movimentacao_listar' %}";
                        });
                    }
                })
                .catch(error => console.error('Error:', error));
        });
    });
</script>